version: 2.1
orbs:
  heroku: circleci/heroku@0.0.8
jobs:
  build:
    docker:
      - image: circleci/node:lts

    steps:
      - checkout
      - run:
          name: Pull submodules
          command: git submodule update --init --recursive
      - run:
          name: Installing client dependencies
          command: npm install
          working_directory: ringsteki-client
      - run:
          name: Building client vendor code
          command: npm run build-vendor
          working_directory: ringsteki-client
      - run:
          name: Build Client
          command: npm run build
          working_directory: ringsteki-client
      - run:
          name: Copy client build output to server
          command: |
            mkdir -p ringsteki-server/public
            cp ringsteki-client/dist/* ringsteki-server/public
            cp -R ringsteki-client/assets/* ringsteki-server/public
            cp ringsteki-client/assets.json ringsteki-server/.
            cp ringsteki-client/vendor-assets.json ringsteki-server/.
      - heroku/install
      - run:
          name: Build docker image and push to Heroku
          command: heroku container:push web
      - run:
          name: release it!
          command: heroku container:release web